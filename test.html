<!DOCTYPE HTML>
<html>

<head>
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="xonomy-3.5.0/xonomy.js"></script>
    <link type="text/css" rel="stylesheet" href="xonomy-3.5.0/xonomy.css" />

    <script type="text/javascript">
        function start() {
            var xml = "<list><item age='100000' /></list>";

            ///////////////////////////////////////
            // Num
            function askNum(defaultString, rule) {
                if (typeof rule.default !== 'undefined' && defaultString.length <= 0) {
                    defaultString = rule.default;
                }
                var minString = "";
                if (typeof rule.min !== 'undefined') {
                    minString = "min=\"" + rule.min + "\"";
                }
                var maxString = "";
                if (typeof rule.max !== 'undefined') {
                    maxString = `max="${rule.max}"`;
                }
                var stepString = "";
                if (typeof rule.precision !== 'undefined') {
                    stepString = `step=${rule.precision}`;
                }
                var descString = "";
                if (typeof rule.desc === 'string') {
                    descString = `<label for="val">${rule.desc}</label>`
                }
                return `
		            <form onsubmit='Xonomy.answer(this.val.value); return false;'>
                    ${descString}
			        <input type='num' name='val' class='focusme' value='${defaultString}' ${stepString} ${minString} ${maxString} />
			        <input type='submit' value='确定' />
		            </form>
	            `;
            }
            function genNumAttrSpec(rule) {
                var numAttrSpec = {
                    asker: askNum,
                    askerParameter: rule,
                    menu: [],
                    validate: function (jsAttribute) {
                        var _rule = this.askerParameter;
                        if (_rule.min !== undefined && jsAttribute.value < _rule.min) {
                            Xonomy.warnings.push({
                                htmlID: jsAttribute.htmlID,
                                text: `值必须大于或等于 ${_rule.min}。`
                            })
                        }
                        if (_rule.max !== undefined && jsAttribute.value > _rule.max) {
                            Xonomy.warnings.push({
                                htmlID: jsAttribute.htmlID,
                                text: `值必须小于或等于 ${_rule.max}。`
                            })
                        }
                    }
                };
                if (typeof rule.tips === 'string') {
                    numAttrSpec.title = rule.tips
                }
                if (rule.optional === true) {
                    numAttrSpec.menu.push({
                        caption: "Delete",
                        action: Xonomy.deleteAttribute,
                        actionParameter: null,
                        hideIf: function (jsAttribute) { return false }
                    });
                }
                return numAttrSpec;
            }

            ///////////////////////////////////////
            // Datetime
            var dateAttrSpec = {
                asker: askDate,
                askerParameter: {},
                menu: [],
            };
            function askDate(defaultString) {
                return `
		            <form onsubmit='Xonomy.answer(this.val.value); return false;'>
			        <input type='datetime-local' name='val' class='focusme' value='${defaultString}' step='1'/>
			        <input type='submit' value='确定' />
		            </form>
	            `;
            }

            var spec = {
                onchange: function () {
                    console.log("Ah been chaaanged!");
                },
                validate: function (jsElement) {
                    if (typeof (jsElement) == "string") jsElement = Xonomy.xml2js(jsElement);
                    var valid = true;
                    var elementSpec = this.elements[jsElement.name];
                    if (elementSpec.validate) {
                        elementSpec.validate(jsElement); //validate the element
                    }
                    for (var iAttribute = 0; iAttribute < jsElement.attributes.length; iAttribute++) {
                        var jsAttribute = jsElement.attributes[iAttribute];
                        var attributeSpec = elementSpec.attributes[jsAttribute.name];
                        if (attributeSpec.validate) {
                            if (!attributeSpec.validate(jsAttribute)) valid = false; //validate the attribute
                        }
                    }
                    for (var iChild = 0; iChild < jsElement.children.length; iChild++) {
                        if (jsElement.children[iChild].type == "element") {
                            var jsChild = jsElement.children[iChild];
                            if (!this.validate(jsChild)) valid = false; //recurse to the child element
                        }
                    }
                    return valid;
                },
                elements: {
                    "list": {
                        menu: [{
                            caption: "添加 <item>",
                            action: Xonomy.newElementChild,
                            actionParameter: "<item />",
                        }],
                        collapsed: function (jsElement) { return false }
                    },
                    "item": {
                        ...genNumAttrSpec({ min: 1, max: 10 }),
                        hasText: true,
                        backgroundColour: "#d6d6ff",
                        menu: [{
                            caption: "Add @age",
                            action: Xonomy.newAttribute,
                            actionParameter: { name: "age", value: "" },
                            hideIf: function (jsElement) { return jsElement.hasAttribute("age"); }
                        },
                        {
                            caption: "Add @height",
                            action: Xonomy.newAttribute,
                            actionParameter: { name: "height", value: "" },
                            hideIf: function (jsElement) { return jsElement.hasAttribute("height"); }
                        },
                        {
                            caption: "Add @create_time",
                            action: Xonomy.newAttribute,
                            actionParameter: { name: "create_time", value: "2018-09-09T23:12:11" },
                            hideIf: function (jsElement) { return jsElement.hasAttribute("create_time"); }
                        }
                        ],
                        attributes: {
                            "age": genNumAttrSpec({ default: 20, min: 0, max: 100, precision: 1, tips : "年龄", desc : "范围(0,100)" }),
                            "height": genNumAttrSpec({ min: 0, max: 200, precision: 0.01, optional: true }),
                            "create_time": dateAttrSpec
                        },
                        collapsed: function (jsElement) { return false }
                    },
                }
            };
            var editor = document.getElementById("editor");
            Xonomy.render(xml, editor, spec);
        }
    </script>
</head>

<body onload="start()">
    <div id="editor"></div>
</body>

</html>